{% extends 'public/base.html' %}

{% block content %}
<section class="container py-4">
    <h2 class="mb-4 text-warning">Resumen del pedido</h2>

    <!-- Lista dinámica del pedido -->
    <ul id="lista-pedido" class="list-group mb-4"></ul>

    {% if user.is_authenticated %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Datos del cliente</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="nombre" class="form-label">Nombre completo</label>
                    <input type="text" id="nombre" class="form-control" value="{{ user.get_full_name }}">
                </div>
                <div class="col-md-4">
                    <label for="telefono" class="form-label">Teléfono (WhatsApp)</label>
                        <div class="input-group">
                            <span class="input-group-text">+54</span>
                            <input type="text" id="telefono" class="form-control" value="{{ telefono }}" placeholder="Ej: 1122334455">
                        </div>
                </div>
                <div class="col-md-4">
                    <label for="direccion" class="form-label">Dirección de entrega</label>
                    <input type="text" id="direccion" class="form-control" value="{{ direccion }}">
                </div>
                <div class="col-md-4">
                    <label for="metodo-pago" class="form-label">Forma de pago</label>
                    <select id="metodo-pago" class="form-select">
                        <option value="">Seleccionar...</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia bancaria">Transferencia bancaria</option>
                        <option value="Tarjeta de crédito">Tarjeta de crédito</option>
                        <option value="Tarjeta de débito">Tarjeta de débito</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="numero-destino" class="form-label">Enviar a (número empresa)</label>
                    <input type="text" id="numero-destino" class="form-control" placeholder="Ej: 5491122334455">
                </div>
            </div>
                    <div class="mt-4 d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-primary" onclick="uiGuardarServidor()" id="btn-guardar-servidor">Guardar en servidor</button>
                        <button type="button" class="btn btn-porta" onclick="uiEnviarWhatsApp()">Enviar pedido por WhatsApp</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="vaciarPedido(); renderPedido();">Vaciar pedido</button>
                    </div>
        </div>
    </div>
    {% else %}
        <p>Debes <a href="{% url 'login' %}">iniciar sesión</a> para hacer un pedido.</p>
    {% endif %}
</section>

<script>
// ===================== Lógica de pedido (vista) =====================
// Esta vista ahora puede: (1) mostrar pedido localStorage, (2) guardarlo en servidor (shadow write), (3) enviar a WhatsApp.
// Cuando se implemente un flujo 100% server-side se podrá reemplazar la lectura localStorage por una API.
// Renderiza la lista del pedido en el UL
function renderPedido() {
    const lista = document.getElementById('lista-pedido');
    const items = JSON.parse(localStorage.getItem('pedido') || '[]');
    if (!items.length) {
        lista.innerHTML = '<li class="list-group-item text-muted">No hay productos en el pedido.</li>';
        return;
    }
    let total = 0;
    lista.innerHTML = items.map(p => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;
        return `<li class='list-group-item d-flex justify-content-between align-items-center'>
                            <span>${p.nombre} x${p.cantidad}</span>
                            <span class='fw-bold'>$${subtotal.toFixed(2)}</span>
                        </li>`;
    }).join('');
    lista.innerHTML += `<li class='list-group-item d-flex justify-content-between'><strong>Total</strong><strong>$${total.toFixed(2)}</strong></li>`;
}

// Toma datos del formulario y usa helpers definidos en carrito.js
function uiEnviarWhatsApp() {
    const datosCliente = {
        nombre: document.getElementById('nombre').value.trim(),
        telefono: document.getElementById('telefono').value.trim(),
        direccion: document.getElementById('direccion').value.trim(),
        metodoPago: document.getElementById('metodo-pago').value.trim()
    };
    const numeroDestino = document.getElementById('numero-destino').value.trim();

    // Validación mínima
    if (!datosCliente.nombre || !datosCliente.telefono || !datosCliente.direccion || !datosCliente.metodoPago) {
        alert('Completá todos los campos del cliente.');
        return;
    }
    if (!numeroDestino) {
        alert('Ingresá el número destino (empresa).');
        return;
    }

    enviarPedidoWhatsApp(numeroDestino, datosCliente);
}

    // Guardar en servidor antes (shadow write) – no bloquea WhatsApp
    async function uiGuardarServidor() {
        const btn = document.getElementById('btn-guardar-servidor');
        btn.disabled = true; btn.textContent = 'Guardando...';
        const datosCliente = {
            nombre: document.getElementById('nombre').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            metodoPago: document.getElementById('metodo-pago').value.trim()
        };
        const res = await enviarPedidoServidor(datosCliente);
        if (res.error) {
            alert('No se pudo guardar: ' + res.error);
        } else {
            alert('Pedido guardado (#' + res.pedido_id + ').');
        }
        btn.disabled = false; btn.textContent = 'Guardar en servidor';
    }

document.addEventListener('DOMContentLoaded', renderPedido);
</script>
{% endblock %}
